<?xml version="1.0" encoding="UTF-8"?>

<project name="CMS configurator" default="main">

    <property name="rewriteBase" value="/" override="true" />
    <property name="role" value="admin" override="true" />

    <!-- ============================================  -->
    <!-- Target: start                                 -->
    <!-- ============================================  -->
    <target name="start">
        <echo message="Welcom to ${phing.project.name}. Please follow these steps to finish configuration." />
    </target>

    <!-- ============================================  -->
    <!-- Target: site                                  -->
    <!-- ============================================  -->
    <target name="site" depends="start">
        <input
            message="Please insert your site adress (example: http://www.example.com)"
            propertyname="siteAdress"
            promptChar=": "
        />
        <input
            message="Please insert your site name"
            propertyname="siteName"
            promptChar=": "
        />
    </target>

    <!-- ============================================  -->
    <!-- Target: database                              -->
    <!-- ============================================  -->
    <target name="database" depends="site">
        <input
            message="Please insert your database host"
            propertyName="dbHost"
            promptChar=": "
        />
        <input
            message="Please insert your database user"
            propertyName="dbUser"
            promptChar=": "
        />
        <input
            message="Please insert your database password"
            propertyName="dbPassword"
            promptChar=": "
        />
        <input
            message="Please insert your database name"
            propertyName="dbName"
            promptChar=": "
        />
    </target>

    <!-- ============================================  -->
    <!-- Target: administrator                         -->
    <!-- ============================================  -->
    <target name="administrator" depends="database">
        <input
            message="Please insert your user login"
            propertyName="login"
            promptChar=": "
        />
        <input
            message="Please insert your user password"
            propertyName="password"
            promptChar=": "
        />
        <input
            message="Please insert your email"
            propertyName="email"
            promptChar=": "
        />
    </target>

    <!-- ============================================  -->
    <!-- Target: create_db_conf_file                   -->
    <!-- ============================================  -->
    <target name="create_db_conf_file" depends="administrator">
        <copy
            file="${project.basedir}/install/DBSettings.php"
            tofile="${project.basedir}/conf/DB/DBSettings.php"
        >
            <filterchain>
                <replacetokens>
                    <token key="dbHost"     value="${dbHost}" />
                    <token key="dbUser"     value="${dbUser}" />
                    <token key="dbPassword" value="${dbPassword}" />
                    <token key="dbName"     value="${dbName}" />
                </replacetokens>
            </filterchain>
        </copy>
    </target>

    <!-- ============================================  -->
    <!-- Target: create_htaccess_file                  -->
    <!-- ============================================  -->
    <target name="create_htaccess_file" depends="create_db_conf_file">
        <copy
            file="${project.basedir}/install/htaccess"
            tofile="${project.basedir}/.htaccess"
        >
            <filterchain>
                <replacetokens>
                    <token key="rewriteBase" value="${rewriteBase}" />
                    <token key="baseDir"     value="${project.basedir}" />
                </replacetokens>
            </filterchain>
        </copy>
    </target>

    <!-- ============================================  -->
    <!-- Target: create_sql_query                      -->
    <!-- ============================================  -->
    <target name="create_sql_query" depends="create_htaccess_file">
        <php expression="require('./vendor/autoload.php');" />
        <php expression="\UserAuth\HashPass::hash(${password});" returnProperty="hashPassword"/>
        <php expression="(new \DateTime('now'))->format('Y-m-d H:i:s');" returnProperty="regDate"/>
        <copy
            file="${project.basedir}/install/structure.sql"
            tofile="${project.basedir}/install/tmp_structure.sql"
        >
            <filterchain>
                <replacetokens>
                    <token key="dbName"       value="${dbName}" />
                </replacetokens>
            </filterchain>
        </copy>
        <copy
            file="${project.basedir}/install/data.sql"
            tofile="${project.basedir}/install/tmp_data.sql"
        >
            <filterchain>
                <replacetokens>
                    <token key="dbName"       value="${dbName}" />
                    <token key="login"        value="${login}" />
                    <token key="email"        value="${email}" />
                    <token key="hashPassword" value="${hashPassword}" />
                    <token key="regDate"      value="${regDate}" />
                    <token key="logDate"      value="${regDate}" />
                    <token key="role"         value="${role}" />
                    <token key="siteName"     value="${siteName}" />
                    <token key="email"        value="${email}" />
                    <token key="siteAdress"   value="${siteAdress}" />
                    <token key="rewriteBase"  value="${rewriteBase}" />
                </replacetokens>
            </filterchain>
        </copy>
        <php expression="require('./install/query.php');" />
    </target>

    <!-- ============================================  -->
    <!-- Target: create_folders                        -->
    <!-- ============================================  -->
    <target name="create_folders" depends="create_sql_query">
        <mkdir dir="${project.basedir}/cache/session" />
        <mkdir dir="${project.basedir}/cache/registry" />
    </target>

    <!-- ============================================  -->
    <!-- Target: clear_cms_configurator_files          -->
    <!-- ============================================  -->
    <target name="clear_cms_configurator_files" depends="create_folders">
        <delete file="${project.basedir}/install/tmp_structure.sql" />
        <delete file="${project.basedir}/install/tmp_data.sql" />
    </target>

    <!-- ============================================  -->
    <!-- Target: main                                  -->
    <!-- ============================================  -->
    <target name="main" depends="clear_cms_configurator_files">
        <echo message="Configuration completed." />
    </target>

</project>